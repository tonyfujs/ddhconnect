---
title: "Contributing Content"
author: "Tony Fujs"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to ddhconnect}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# DDHCONNECT: Contributing Content
With proper authorization, you can add and update datasets and resources to the Data Catalog through `ddhconnect`.
Note: In line with the DKAN terminology, in this vignette, we use dataset to refer to the node that has all the metadata and resource to refer to the node that has data files, links or any supporting documents.

## Setting Up Your Connection
First, begin by setting up your account with the following `dkanr_setup` function to authenticate the user. Login information for access to the API's extended services can be obtained by contacting the World Bank's IT Services, provided you are authorized for these credentials.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
library(dkanr)
library(ddhconnect)
dkanr_setup(
  url = 'https://datacatalog.worldbank.org',
  username = 'YOUR_USERNAME',
  password = 'YOUR_PASSWORD'
)
```

___

## Adding a new dataset
To add a new dataset to the site, begin by formatting your metadata into a named vector with the field names and corresponding values. You can pass this named vector to `create_json_body()`, which formats the metadata in the required JSON format. You can refer to the the data-raw folder to see which fields are required for the different data types. 

```{r}
metadata = c("title" = "Test Poverty Map",
           "body" = "Dataset to test the addition of poverty map datasets into DDH.",
           "field_topic" = "376",
           "field_wbddh_data_class" = "358",
           "field_wbddh_data_type" = "295",
           "field_wbddh_languages_supported" = "337",
           "field_frequency" = "18",
           "field_wbddh_economy_coverage" = "1013",
           "field_wbddh_country" = "35;36;37",
           "field_license_wbddh" = "1341",
           "workflow_status" = "published")
json_dataset <- create_json_body(values = metadata,
                                 node_type = "dataset")
```

One thing to note here is that fields that take a controlled vocabulary for input use a mapped id for the value. You can find the ids corresponding to the controlled vocabulary using `get_lovs()`.

```{r}
tid_mapping <- get_lovs()
tid_mapping
```


After producing the formatted JSON, you can add this information to the Data Catalog using `create_dataset()`.
```{r message = FALSE, warning = FALSE, paged.print = FALSE, eval = FALSE}
resp_dataset <- create_dataset(body = json_dataset)
```

`create_dataset()` prints the node id of the node created for your new dataset. You can view the metadata using `get_metadata()`.
```{r message = FALSE, warning = FALSE, paged.print = FALSE, eval = FALSE}
your_dataset <- get_metadata(resp_dataset$nid)
your_dataset
```

### Adding a corresponding resource
Once the metadata is submitted, you can add the data files, links and supporting documents as resources. Again, you can add a resource to the Data Catalog by creating a named list of the resource metadata, formatting it in JSON format using `create_json_body()`, and creating a resource node using `create_resource()`.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
resource_metadata <-  c("title" = "Test Poverty Map Resource",
                        "field_wbddh_data_class" = "358",
                        "field_wbddh_resource_type" = "986",
                        "workflow_status" = "published")
json_resource <- create_json_body(values = resource_metadata,
                                  node_type = "resource")
resp_resource <- create_resource(body = json_resource)
```

If your resource is a local file, you can upload it to the Data Catalog using `attach_file_to_resource()`.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
attach_file_to_resource(resource_nid = resp_resource$nid, file_path = "PATH TO YOUR FILE")
```


After the resource is added to the Data Catalog, it can be attached to your dataset using `attach_resources_to_dataset()`. Multiple resources can be attached to a dataset by passing a list of resource nids.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
attach_resources_to_dataset(dataset_nid = resp_dataset$nid, resource_nid = resp_resource$nid)
```

## Updating Content
Updating content in the Data Catalog requires knowing the node ID of the content you wish you edit.

### updating a dataset
To obtain the node id, you may search the catalog based on the title of the object. For example, passing the following parameters will return the node id for the World Development Indicators.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
indicators_search <- search_catalog(fields = c("nid", "title"),
                                    filters = c("title" = "World Development Indicators"))
wdi_nid <- indicators_search[[1]]$nid
```

### updating a resource
Use the same process as with creating a new dataset, use named vector with the formatted metadata and passing it to create a JSON body. To update the node, use the `update_dataset()` function.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
update_metadata = c("title" = "YOUR DATASET TITLE",
     "field_wbddh_country" = "YOUR DATASET COUNTRY")
mapped_values <- map_tids(update_metadata)
dataset_json = create_json_body(values = mapped_values, node_type = “dataset”)
update_dataset(credentials, body = dataset_json)
```

Use the same method to update the resource metadata. First, get the resource node id. Second, format the JSON. Lastly, use the `update_resource` function.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
resource_metadata = c("title" = "YOUR RESOURCE TITLE",
     "field_wbddh_country" = "YOUR RESOURCE COUNTRY")
resource_json = create_json_body(values = resource_metadata, node_type = “resource”)
update_resource(credentials, body = resource_json)
```

## Ending Your Connection
After finishing your tasks, you can log out of your account.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
logout_ddh()
```
