---
title: "Contributing Content"
author: "Tony Fujs"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
runtime: shiny
vignette: >
  %\VignetteIndexEntry{Introduction to ddhconnect}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

# DDHCONNECT: Contributing Content
With proper authorization, you can add and update datasets and resources to the Data Catalog through `ddhconnect`.

## Terminology
In line with the DKAN terminology, dataset is used to refer to a node that has all the metadata for the data and resource is used refer to a node that has the data file, link to the data file or any supporting document.

## Setting Up Your Connection
First, begin by setting up your account with the following `dkanr_setup` function to authenticate the user. Login information for access to the API's extended services can be obtained by contacting the World Bank's IT Services, provided you are authorized for these credentials.
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(dkanr)
library(ddhconnect)
dkanr_setup(
  url = 'https://datacatalog.worldbank.org',
  username = Sys.getenv("username"),
  password = Sys.getenv("password")
)
```

___

## Adding Content
To add content to the Data Catalog, you need to add the metadata as a dataset node and the corresponding data files, links and supporting documentation as resources. Suppose we want to add a dataset with the following information to the Data Catalog and then attach a zip file containing the data as the resource. 

```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
metadata = c("title" = "Test Poverty Map",
           "body" = "Dataset to test the addition of poverty map datasets into DDH.",
           "field_topic" = "Poverty",
           "field_wbddh_data_class" = "Public",
           "field_wbddh_data_type" = "Geospatial",
           "field_wbddh_languages_supported" = "English",
           "field_frequency" = "Periodicity not specified",
           "field_wbddh_economy_coverage" = "Blend",
           "field_wbddh_country" = "Afghanistan;Albania;Algeria",
           "field_license_wbddh" = "Custom License",
           "workflow_status" = "published")
```

Some fields such as `field_topic` and `field_wbddh_data_class` take a controlled list of values as input. These values need to be mapped to their internal ids before they can be added to the Data Catalog. You can get a list of the fields that take a controlled list of values and the mapping from the controlled list of values to the corresponding ids using `get_lovs()`.

```{r}
tid_mapping <- get_lovs()
head(tid_mapping)
```

For example, to get the tids corresponding to the topics of the dataset, you can look for `"field_topic"`:

```{r}
tid_mapping[tid_mapping$machine_name == "field_topic", c("machine_name", "list_value_name", "tid")]
```

### Adding a new dataset
To add a new dataset to the site, begin by formatting your metadata into a named vector with the field names and corresponding values. You can pass this named vector to `create_json_body()`, which formats the metadata in the required JSON format. You can refer to the the data-raw folder to see which fields are required for the different data types. 

```{r message = FALSE, warning = FALSE, paged.print = FALSE, eval = FALSE}
metadata = c("title" = "Test Poverty Map",
           "body" = "Dataset to test the addition of poverty map datasets into DDH.",
           "field_topic" = "376",
           "field_wbddh_data_class" = "358",
           "field_wbddh_data_type" = "295",
           "field_wbddh_languages_supported" = "337",
           "field_frequency" = "18",
           "field_wbddh_economy_coverage" = "1013",
           "field_wbddh_country" = "35;36;37",
           "field_license_wbddh" = "1341",
           "workflow_status" = "published")
json_dataset <- create_json_body(values = metadata,
                                 node_type = "dataset")
```

Using the formatted JSON, you can add the dataset to the Data Catalog using `create_dataset()`.
```{r message = FALSE, warning = FALSE, paged.print = FALSE, eval = FALSE}
resp_dataset <- create_dataset(body = json_dataset)
```

`create_dataset()` prints the node id of the node created for your new dataset. You can view the metadata using `get_metadata()`.
```{r message = FALSE, warning = FALSE, paged.print = FALSE, eval = FALSE}
your_dataset <- get_metadata(resp_dataset$nid)
your_dataset
```

### Adding a resource to the dataset
Once the dataset node is created, you can add the data files, links and supporting documents as resources. Again, you can add a resource to the Data Catalog by creating a named list of the resource metadata, formatting it in JSON format using `create_json_body()`, and creating a resource node using `create_resource()`.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
resource_metadata <-  c("title" = "Test Poverty Map Resource",
                        "field_wbddh_data_class" = "358",
                        "field_wbddh_resource_type" = "986",
                        "workflow_status" = "published")
json_resource <- create_json_body(values = resource_metadata,
                                  node_type = "resource")
resp_resource <- create_resource(body = json_resource)
```

If your resource is a local file, you can upload it to the Data Catalog using `attach_file_to_resource()`.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
attach_file_to_resource(resource_nid = resp_resource$nid, file_path = "PATH TO YOUR FILE")
```


After the resource is added to the Data Catalog, it can be attached to your dataset using `attach_resources_to_dataset()`. Multiple resources can be attached to a dataset by passing a vector of resource nids.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
attach_resources_to_dataset(dataset_nid = resp_dataset$nid, resource_nid = resp_resource$nid)
```

## Updating Content
To update content in the Data Catalog, you need to know the node ID of the dataset you wish you edit. To obtain the node id, you can search the catalog based on the title of the object. For example, to get the node id of the "Test Poverty Map" dataset that we just created, we could do a search using `search_catalog()`.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
search_results <- search_catalog(fields = c("nid", "title"),
                                 filters = c("title" = "Test Poverty Map"))
poverty_map_nid <- search_results[[1]]$nid
```

### Updating a dataset

The process for updating a dataset is similar to the process of adding a new dataset. Create a named vector with the metadata fields to be updated and the new values. Format the metadata using `create_json_body()` and pass it to `update_dataset()` to update the dataset.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
update_dataset_metadata <- c("field_wbddh_country" = "59",
                             "field_tags" = "1236",
                             "workflow_status" = "published")
update_dataset_json <- create_json_body(values = update_dataset_metadata, node_type = “dataset”)
resp_update_dataset <- update_dataset(nid = poverty_map_nid, body = update_dataset_json)
```
Note that you need to set the "workflow_status" to "published" everytime you update the node.

### Updating a resource

You can use the same method to update the resource metadata. Get the resource node id, format the metadata using `create_json_body()` and update the resource using `update_resource()`.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
update_resource_metadata <-  c("field_format" = "666",
                               "workflow_status" = "published")
update_resource_json <- create_json_body(values = update_resource_metadata, node_type = “resource”)
resource_nid <- get_resource_nid(poverty_map_nid)
resp_update_resource <- update_resource(nid = resource_nid, body = resource_json)
```
Note that the functionality to search for resources is not available currently. So you can search for the dataset that the resource is attached to and get the node ids of the attached resources using `get_resource_nid()`.

## Ending Your Connection
After finishing your tasks, you can log out of your account.
```{r message=FALSE, warning=FALSE, paged.print=FALSE, eval=FALSE}
logout_ddh()
```
